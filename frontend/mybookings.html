<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Bookings | SkyBook</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        .container { max-width: 800px; margin: 40px auto; padding: 20px; }
        
        /* --- BOOKING CARD (Clean Style) --- */
        .booking-card {
            background: white; 
            padding: 25px; 
            border-radius: 16px; 
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); 
            border-left: 5px solid #ff4d88;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s;
        }
        .booking-card:hover { transform: translateY(-3px); }

        /* --- STATUS BADGES --- */
        .status-badge {
            background: #d1fae5; color: #065f46; /* Green */
            padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;
            display: inline-block; margin-bottom: 10px; text-transform: uppercase;
        }
        .status-cancelled { background: #fee2e2; color: #991b1b; } 
        .status-pending { background: #ffedd5; color: #9a3412; }   

        /* --- BUTTONS --- */
        .action-area { text-align: right; display: flex; flex-direction: column; gap: 8px; align-items: flex-end; }
        
        .btn-ticket {
            padding: 10px 20px; font-size: 13px; background: #333; color: white; 
            border: none; border-radius: 8px; cursor: pointer; font-weight: 600;
        }
        .btn-ticket:hover { background: #000; }

        .btn-cancel {
            padding: 8px 15px; font-size: 12px; background: white; color: #ef4444; 
            border: 1px solid #ef4444; border-radius: 8px; cursor: pointer; font-weight: 600;
        }
        .btn-cancel:hover { background: #fee2e2; }

        /* --- TICKET MODAL (Overlay) --- */
        #ticketModal {
            display: none; /* Hidden by default */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 10000;
            justify-content: center; align-items: center;
            overflow-y: auto;
        }
        
        #ticketContent {
            background: white; width: 700px; padding: 0; 
            border-radius: 4px; position: relative; margin: 50px auto;
        }

        .close-modal {
            position: absolute; top: -40px; right: 0; color: white; font-size: 30px; cursor: pointer;
        }

        /* --- TICKET DESIGN --- */
        .ticket-header { background: #333; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .ticket-body { padding: 30px; background: #fff; color: #000; font-family: 'Courier New', Courier, monospace; }
        .info-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .info-table td { padding: 8px 0; vertical-align: top; }
        .label { font-size: 10px; color: #666; text-transform: uppercase; display: block; margin-bottom: 2px; }
        .val { font-size: 16px; font-weight: bold; color: #000; }
        .highlight { color: #ff4d88; font-size: 20px; }
        .p-table { width: 100%; border-top: 2px dashed #ccc; margin-top: 10px; }
        .p-table th { text-align: left; font-size: 11px; color: #555; padding: 10px 0 5px 0; }
        .p-table td { padding: 5px 0; font-size: 14px; font-weight: bold; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

    <div class="navbar">
        <h2>SkyBook ✈️</h2>
        <div style="display: flex; gap: 20px; align-items: center;">
            <a href="search.html">Book Flight</a>
            <a href="index.html" onclick="localStorage.clear()"style="color: #ff4d88; border: 1px solid #ff4d88; padding: 5px 15px; border-radius: 20px; text-decoration: none;">Log Out</a>
        </div>
    </div>

    <div class="plane-container"><div class="plane-icon">✈️</div></div>
    <div class="cloud one"></div>
    <div class="cloud two"></div>

    <div class="container">
        <h1 style="text-align: center; color: #333; margin-bottom: 10px;">My Bookings</h1>
        <p style="text-align: center; color: #777; margin-bottom: 40px;" id="userDisplay">--</p>

        <div id="bookingsList">
            <p style="text-align: center;">Loading your trips...</p>
        </div>
    </div>

    <div id="ticketModal">
        <div style="position: relative; width: 700px;">
            <span class="close-modal" onclick="closeModal()">×</span>
            <div id="ticketContent">
                <div class="ticket-header">
                    <h2>SKYBOOK AIR</h2>
                    <span>BOARDING PASS</span>
                </div>
                <div class="ticket-body">
                    <table class="info-table">
                        <tr>
                            <td><span class="label">PNR</span><span class="val highlight" id="pdfPnr">--</span></td>
                            <td><span class="label">Date</span><span class="val" id="pdfDate">--</span></td>
                        </tr>
                        <tr>
                            <td><span class="label">Origin</span><span class="val" id="pdfOrigin">--</span></td>
                            <td><span class="label">Destination</span><span class="val" id="pdfDest">--</span></td>
                        </tr>
                    </table>
                    
                    <div style="font-size: 12px; font-weight: bold; margin-top: 10px;">PASSENGER DETAILS</div>
                    <table class="p-table">
                        <thead><tr><th style="width:70%">NAME</th><th style="text-align:right">SEAT</th></tr></thead>
                        <tbody id="pdfListBody"></tbody>
                    </table>

                    <div style="margin-top: 20px; text-align: right; border-top: 2px solid #333; padding-top: 10px;">
                        <span class="label">TOTAL PAID</span>
                        <span class="val" id="pdfPrice">--</span>
                    </div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="savePDF()" class="btn-ticket" style="padding: 15px 30px; font-size: 16px; width: 100%;">Confirm Download</button>
            </div>
        </div>
    </div>

    <script>
        // UPDATED TO LIVE SERVER
        //const API_BASE = "http://127.0.0.1:8000";
        const API_BASE = "https://flight-backend-d2cb.onrender.com";
        const email = localStorage.getItem("userEmail") || localStorage.getItem("loggedUser");

        document.addEventListener("DOMContentLoaded", async () => {
            if (!email) { 
                alert("Please log in first.");
                window.location.href = "login.html"; 
                return;
            }
            
            document.getElementById("userDisplay").innerText = `Account: ${email}`;
            loadBookings();
        });

        async function loadBookings() {
            const listDiv = document.getElementById("bookingsList");
            try {
                const res = await fetch(`${API_BASE}/my-bookings/${email}`);
                
                if(!res.ok) throw new Error("API Error");
                
                const bookings = await res.json();

                if (!bookings || bookings.length === 0) {
                    listDiv.innerHTML = "<p style='text-align:center;'>No bookings found.</p>";
                    return;
                }

                listDiv.innerHTML = ""; 

                bookings.forEach(b => {
                    const safeNames = encodeURIComponent(b.passenger_names);
                    const safeSeats = encodeURIComponent(b.seats);

                    let badgeClass = "";
                    if (b.status === "CANCELLED") badgeClass = "status-cancelled";
                    else if (b.status === "PENDING_PAYMENT") badgeClass = "status-pending";
                    
                    const card = document.createElement("div");
                    card.className = "booking-card";
                    if (b.status === "CANCELLED") card.style.opacity = "0.6";

                    card.innerHTML = `
                        <div style="flex: 1;">
                            <span class="status-badge ${badgeClass}">${b.status.replace("_", " ")}</span>
                            <div style="font-size: 14px; color: #888;">PNR: <b>${b.pnr}</b></div>
                            
                            <div style="margin-top: 10px;">
                                <span style="font-size: 18px; font-weight: bold; color: #333;">${b.origin} ➝ ${b.destination}</span>
                            </div>
                            <div style="margin-top: 5px; font-size: 13px; color: #666;">
                                ${b.travel_date} • ${b.flight_number}
                            </div>
                            <div style="font-size: 13px; color: #666; margin-top: 2px;">
                                ${b.passenger_count} Passenger(s) • Seats: ${b.seats}
                            </div>
                        </div>

                        <div class="action-area">
                            <div style="font-weight: bold; font-size: 20px; color: #ff4d88; margin-bottom: 5px;">₹${b.total_price}</div>
                            
                            ${b.status === "CONFIRMED" ? `
                                <button onclick="openTicketModal('${b.pnr}', '${b.origin}', '${b.destination}', '${b.travel_date}', '${safeNames}', '${safeSeats}', '${b.total_price}')" 
                                    class="btn-ticket">
                                    ⬇ Ticket
                                </button>
                                <button onclick="cancelBooking('${b.pnr}')" class="btn-cancel">
                                    Cancel Booking
                                </button>
                            ` : ``}
                        </div>
                    `;
                    listDiv.appendChild(card);
                });

            } catch (e) {
                console.error(e);
                listDiv.innerHTML = "<p style='color:red; text-align:center;'>Unable to load bookings. Server might be sleeping.</p>";
            }
        }

        async function cancelBooking(pnr) {
            if (!confirm(`Are you sure you want to cancel PNR: ${pnr}?`)) return;

            try {
                const res = await fetch(`${API_BASE}/booking/${pnr}`, { method: 'DELETE' });
                if (res.ok) {
                    alert("Booking Cancelled.");
                    loadBookings(); 
                } else {
                    alert("Failed to cancel.");
                }
            } catch (e) { alert("Server error."); }
        }

        function openTicketModal(pnr, from, to, date, namesEnc, seatsEnc, price) {
            const names = decodeURIComponent(namesEnc).split(", ");
            const seats = decodeURIComponent(seatsEnc).split(", ");

            document.getElementById("pdfPnr").innerText = pnr;
            document.getElementById("pdfOrigin").innerText = from;
            document.getElementById("pdfDest").innerText = to;
            document.getElementById("pdfDate").innerText = date;
            document.getElementById("pdfPrice").innerText = "₹" + price;

            let html = "";
            for(let i=0; i<names.length; i++) {
                html += `<tr><td>${names[i]}</td><td style="text-align:right; color:#ff4d88;">${seats[i]}</td></tr>`;
            }
            document.getElementById("pdfListBody").innerHTML = html;

            // Show Modal
            document.getElementById("ticketModal").style.display = "flex";
        }

        function closeModal() {
            document.getElementById("ticketModal").style.display = "none";
        }

        function savePDF() {
            const element = document.getElementById("ticketContent");
            const pnr = document.getElementById("pdfPnr").innerText;

            const opt = {
                margin: 10,
                filename: `SkyBook_Ticket_${pnr}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                closeModal(); 
            });
        }
    </script>
</body>
</html>