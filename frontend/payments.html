<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment & Ticket | SkyBook</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Payment Page Styles */
        .payment-container {
            max-width: 500px;
            margin: 80px auto;
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .input-group {
            margin-bottom: 15px;
            text-align: left;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 13px;
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
        }

        /* --- BOARDING PASS DESIGN (Hidden initially) --- */
        #ticketArea {
            display: none; /* Hidden until payment success */
            max-width: 600px;
            margin: 20px auto;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 1px solid #eee;
        }

        .ticket-header {
            background: linear-gradient(135deg, #ff4d88, #ff8fb1);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ticket-body {
            padding: 25px;
            display: flex;
            justify-content: space-between;
        }

        .ticket-info label {
            display: block;
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 2px;
        }
        .ticket-info p {
            margin: 0 0 15px 0;
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }

        .barcode {
            height: 40px;
            background: repeating-linear-gradient(
                90deg,
                #333,
                #333 2px,
                #fff 2px,
                #fff 4px
            );
            margin-top: 10px;
            width: 100%;
        }

        /* Animations */
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>

    <div class="navbar">
        <h2>SkyBook ‚úàÔ∏è</h2>
    </div>

    <div class="plane-container"><div class="plane-icon">‚úàÔ∏è</div></div>
    <div class="cloud one"></div>
    <div class="cloud two"></div>

    <div id="paymentSection" class="payment-container">
        <h2 style="color: #333;">Confirm Payment</h2>
        <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
            PNR: <strong id="dispPnr">--</strong> | Amount: <strong id="dispPrice" style="color: #ff4d88;">--</strong>
        </p>

        <div class="input-group">
            <label>Card Number</label>
            <input type="text" placeholder="0000 0000 0000 0000" maxlength="19">
        </div>
        <div style="display: flex; gap: 15px;">
            <div class="input-group" style="flex: 1;">
                <label>Expiry</label>
                <input type="text" placeholder="MM/YY" maxlength="5">
            </div>
            <div class="input-group" style="flex: 1;">
                <label>CVV</label>
                <input type="password" placeholder="123" maxlength="3">
            </div>
        </div>

        <button id="payBtn" class="primary-btn" style="width: 100%; margin-top: 10px;">
            Pay Securely
        </button>
    </div>

    <div id="successSection" style="display: none; padding-top: 80px; text-align: center;">
        <div style="animation: popIn 0.5s ease forwards;">
            <div style="font-size: 50px;">üéâ</div>
            <h2 style="color: #333; margin: 10px 0;">Booking Confirmed!</h2>
            <p style="color: #666;">Your ticket is ready.</p>
            
            <div id="ticketArea">
                <div class="ticket-header">
                    <h3 style="margin:0;">SkyBook Air</h3>
                    <span style="font-size: 12px; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 10px;">BOARDING PASS</span>
                </div>
                <div class="ticket-body">
                    <div style="text-align: left; flex: 1;">
                        <div class="ticket-info">
                            <label>Passenger</label>
                            <p id="ticketName">--</p>
                        </div>
                        <div class="ticket-info">
                            <label>From</label>
                            <p id="ticketFrom">--</p>
                        </div>
                        <div class="ticket-info">
                            <label>Date</label>
                            <p id="ticketDate">--</p>
                        </div>
                    </div>

                    <div style="text-align: right; flex: 1;">
                        <div class="ticket-info">
                            <label>Class</label>
                            <p id="ticketClass">Economy</p>
                        </div>
                        <div class="ticket-info">
                            <label>To</label>
                            <p id="ticketTo">--</p>
                        </div>
                        <div class="ticket-info">
                            <label>Seat</label>
                            <p id="ticketSeat" style="color: #ff4d88; font-size: 22px;">--</p>
                        </div>
                    </div>
                </div>
                <div style="padding: 0 25px 25px 25px;">
                    <div class="ticket-info" style="text-align: center;">
                        <label>PNR</label>
                        <p id="ticketPnr" style="margin-bottom: 5px;">--</p>
                    </div>
                    <div class="barcode"></div>
                </div>
            </div>

            <div style="margin-top: 30px; display: flex; justify-content: center; gap: 15px;">
                <button onclick="downloadPDF()" class="primary-btn" style="background: #333;">
                    ‚¨á Download PDF
                </button>
                <a href="index.html" class="primary-btn" style="background: white; color: #333; border: 1px solid #ddd;">
                    Go Home
                </a>
            </div>
        </div>
    </div>

    <script>
        // --- UPDATED API URL (This now points to your live backend) ---
        const API_BASE = "https://flight-backend-d2cb.onrender.com";
        const pnr = localStorage.getItem("pnr");

        if (!pnr) {
            alert("No booking found.");
            window.location.href = "index.html";
        }

        // 1. Load Booking Data on Page Load
        async function loadBooking() {
            try {
                // Fetch details from backend
                const res = await fetch(`${API_BASE}/booking/${pnr}`);
                const data = await res.json();

                // Fetch Flight details to get Origin/Dest names
                const fRes = await fetch(`${API_BASE}/flights`);
                const flights = await fRes.json();
                const flight = flights.find(f => f.flight_id == data.flight_id);

                // --- Update Payment Screen ---
                document.getElementById("dispPnr").innerText = data.pnr;
                document.getElementById("dispPrice").innerText = "‚Çπ" + data.price;

                // --- Update Ticket (Hidden) ---
                document.getElementById("ticketName").innerText = data.passenger;
                document.getElementById("ticketSeat").innerText = data.seat_no;
                document.getElementById("ticketPnr").innerText = data.pnr;
                document.getElementById("ticketDate").innerText = data.travel_date;
                
                if (flight) {
                    document.getElementById("ticketFrom").innerText = flight.origin;
                    document.getElementById("ticketTo").innerText = flight.destination;
                }

                // Business Class Logic
                const rowNum = parseInt(data.seat_no);
                if (rowNum < 5) {
                    document.getElementById("ticketClass").innerText = "Business";
                    document.getElementById("ticketClass").style.color = "#b45309";
                    document.getElementById("ticketClass").style.fontWeight = "bold";
                }

            } catch (err) {
                console.error(err);
                alert("Error loading booking details");
            }
        }

        loadBooking();

        // 2. Handle Payment Click
        document.getElementById("payBtn").addEventListener("click", async () => {
            const btn = document.getElementById("payBtn");
            btn.innerText = "Processing...";
            btn.disabled = true;

            // Simulate Network Delay (2 seconds)
            setTimeout(async () => {
                try {
                    const res = await fetch(`${API_BASE}/booking/pay/${pnr}`, { method: "POST" });
                    const result = await res.json();

                    if (result.payment_status === "CONFIRMED") {
                        // Switch Views
                        document.getElementById("paymentSection").style.display = "none";
                        document.getElementById("successSection").style.display = "block";
                        // Reveal ticket for viewing (and downloading)
                        document.getElementById("ticketArea").style.display = "block"; 
                    } else {
                        alert("Payment Failed. Try again.");
                        btn.innerText = "Pay Securely";
                        btn.disabled = false;
                    }
                } catch (e) {
                    alert("Server Error");
                }
            }, 2000);
        });

        // 3. PDF Download Function
        function downloadPDF() {
            // Select the ticket element
            const element = document.getElementById("ticketArea");
            
            // Configuration Options
            const opt = {
                margin:       10,  // Adds whitespace around the ticket in the PDF
                filename:     `SkyBook_Ticket_${pnr}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { 
                    scale: 2,       // Makes text sharp
                    useCORS: true,  // Important for external images/fonts
                    scrollY: 0      // Prevents cutting off bottom
                },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            // Generate
            html2pdf().set(opt).from(element).save();
        }
    </script>
</body>
</html>