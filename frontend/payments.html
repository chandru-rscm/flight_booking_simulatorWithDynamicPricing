<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Payment & Ticket | SkyBook</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* --- LAYOUT & WRAPPER --- */
        .payment-wrapper { 
            max-width: 1000px; 
            margin: 50px auto; 
            display: flex; 
            gap: 30px; 
            align-items: flex-start;
            padding: 0 20px;
        }
        
        /* --- LEFT: SUMMARY CARD --- */
        .summary-card { 
            flex: 1; 
            background: white; 
            padding: 30px; 
            border-radius: 16px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); 
            border-top: 5px solid #ff4d88;
        }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; color: #555; }
        .total-row { display: flex; justify-content: space-between; font-size: 22px; font-weight: 800; color: #333; margin-top: 15px; }

        /* --- RIGHT: PAYMENT METHODS --- */
        .payment-methods { 
            flex: 1.8; 
            background: white; 
            padding: 30px; 
            border-radius: 16px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); 
        }
        
        /* TABS for Payment Modes */
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .tab-btn {
            background: none; border: none; font-size: 14px; font-weight: 600; color: #777; cursor: pointer; padding: 10px 15px; border-radius: 8px; transition: 0.3s;
        }
        .tab-btn:hover { background: #f9f9f9; color: #333; }
        .tab-btn.active { background: #fff0f5; color: #ff4d88; font-weight: 800; }

        /* INPUT STYLES */
        .input-group { margin-bottom: 15px; }
        .input-label { display: block; font-size: 12px; font-weight: 700; color: #333; margin-bottom: 5px; text-transform: uppercase; }
        input, select { 
            width: 100%; padding: 14px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; font-size: 15px; transition: 0.2s;
        }
        input:focus, select:focus { border-color: #ff4d88; outline: none; box-shadow: 0 0 0 3px rgba(255, 77, 136, 0.1); }

        .row-inputs { display: flex; gap: 15px; }
        
        /* PAYMENT BUTTON */
        .pay-action-btn { 
            width: 100%; padding: 16px; background: #ff4d88; color: white; border: none; border-radius: 10px; 
            font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 25px; transition: 0.2s; box-shadow: 0 5px 15px rgba(255, 77, 136, 0.3);
        }
        .pay-action-btn:hover { background: #e63e75; transform: translateY(-2px); }
        .pay-action-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

        .secure-badge { text-align: center; margin-top: 15px; font-size: 12px; color: #888; display: flex; align-items: center; justify-content: center; gap: 5px; }

        .hidden { display: none; }

        /* --- TICKET STYLES --- */
        #ticketContainer {
            max-width: 750px; margin: 30px auto; background: #ffffff; 
            border: 2px solid #333; font-family: 'Courier New', Courier, monospace; color: #000;
            display: none; /* Hidden until payment success */
        }
        .ticket-header { background: #333; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .ticket-body { padding: 30px; background: #fff; }
        .info-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .info-table td { padding: 8px 0; vertical-align: top; }
        .label { font-size: 10px; color: #666; text-transform: uppercase; display: block; margin-bottom: 2px; }
        .val { font-size: 16px; font-weight: bold; color: #000; }
        .highlight { color: #ff4d88; font-size: 20px; }
        .p-table { width: 100%; border-top: 2px dashed #ccc; margin-top: 10px; }
        .p-table th { text-align: left; font-size: 11px; color: #555; padding: 10px 0 5px 0; }
        .p-table td { padding: 8px 0; font-size: 14px; font-weight: bold; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>
    <div class="navbar">
        <h2>SkyBook ‚úàÔ∏è</h2>
        <a href="search.html" style="text-decoration:none; color:#555;">Cancel</a>
    </div>

    <div class="payment-wrapper" id="paymentSection">
        
        <div class="summary-card">
            <h3 style="margin-top:0; color:#333;">Flight Summary</h3>
            <div class="summary-row"><span>Flight</span><strong id="sumFlight">--</strong></div>
            <div class="summary-row"><span>Route</span><strong id="sumRoute">--</strong></div>
            <div class="summary-row"><span>Passengers</span><strong id="sumPassCount">--</strong></div>
            <div class="summary-row"><span>Seats</span><strong id="sumSeats" style="color:#ff4d88">--</strong></div>
            <div class="summary-row"><span>Date</span><strong id="sumDate">--</strong></div>
            <hr style="border:0; border-top:1px dashed #ddd; margin: 20px 0;">
            <div class="total-row">
                <span>Total Due</span>
                <span id="sumAmount">‚Çπ0</span>
            </div>
        </div>

        <div class="payment-methods">
            <h2 style="margin-top:0; font-size:24px;">Payment Details</h2>
            <p style="color:#666; font-size:14px; margin-bottom:20px;">Complete your purchase by providing your payment details.</p>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchMethod('card')">üí≥ Credit/Debit Card</button>
                <button class="tab-btn" onclick="switchMethod('upi')">üì± UPI / GPay</button>
                <button class="tab-btn" onclick="switchMethod('net')">üè¶ Net Banking</button>
            </div>

            <div id="form-card">
                <div class="input-group">
                    <label class="input-label">Card Number</label>
                    <input type="text" placeholder="0000 0000 0000 0000" maxlength="19" id="cardNum">
                </div>
                <div class="input-group">
                    <label class="input-label">Card Holder Name</label>
                    <input type="text" placeholder="Name on Card">
                </div>
                <div class="row-inputs">
                    <div class="input-group" style="flex:1">
                        <label class="input-label">Expiry Date</label>
                        <input type="text" placeholder="MM / YY" maxlength="5">
                    </div>
                    <div class="input-group" style="flex:1">
                        <label class="input-label">CVV / CVC</label>
                        <input type="password" placeholder="123" maxlength="3">
                    </div>
                </div>
            </div>

            <div id="form-upi" class="hidden">
                <div class="input-group">
                    <label class="input-label">UPI ID / VPA</label>
                    <input type="text" placeholder="username@oksbi">
                </div>
                <p style="font-size:12px; color:#666; margin-top:10px;">
                    Google Pay, PhonePe, Paytm, and BHIM are supported.
                </p>
            </div>

            <div id="form-net" class="hidden">
                <div class="input-group">
                    <label class="input-label">Select Bank</label>
                    <select>
                        <option>HDFC Bank</option>
                        <option>State Bank of India (SBI)</option>
                        <option>ICICI Bank</option>
                        <option>Axis Bank</option>
                        <option>Kotak Mahindra Bank</option>
                    </select>
                </div>
            </div>

            <button id="payBtn" class="pay-action-btn" onclick="processPayment()">
                Pay Securely
            </button>
            
            <div class="secure-badge">
                üîí 256-bit SSL Secure Payment
            </div>
        </div>
    </div>

    <div id="successSection" class="hidden" style="text-align: center; padding: 50px 20px;">
        <div style="font-size: 60px;">üéâ</div>
        <h1 style="color: #059669; font-size: 32px; margin: 10px 0;">Booking Confirmed!</h1>
        
        <p style="color: #333; font-size: 16px; margin-bottom: 5px;">
            Thank you for booking with SkyBook.
        </p>
        <p style="color: #666; font-size: 14px; margin-bottom: 30px;">
            ‚úÖ A confirmation email has been sent to your registered email.<br>
        </p>

        <div id="ticketContainer">
            <div class="ticket-header">
                <h2>SKYBOOK AIR</h2>
                <span>BOARDING PASS</span>
            </div>
            <div class="ticket-body">
                <table class="info-table">
                    <tr>
                        <td><span class="label">PNR</span><span class="val highlight" id="tPnr">--</span></td>
                        <td><span class="label">Date</span><span class="val" id="tDate">--</span></td>
                        <td style="text-align: right;"><span class="label">Time</span><span class="val" id="tTime">--</span></td>
                    </tr>
                    <tr>
                        <td><span class="label">Origin</span><span class="val" id="tOrigin">--</span></td>
                        <td style="font-size: 20px; text-align: center;">‚úà</td>
                        <td style="text-align: right;"><span class="label">Destination</span><span class="val" id="tDest">--</span></td>
                    </tr>
                </table>
                
                <div style="font-size: 12px; font-weight: bold; margin-top: 10px;">PASSENGER DETAILS</div>
                <table class="p-table">
                    <thead>
                        <tr>
                            <th style="width: 70%;">NAME</th>
                            <th style="text-align: right;">SEAT</th>
                        </tr>
                    </thead>
                    <tbody id="pListBody"></tbody>
                </table>

                <div style="margin-top: 20px; text-align: right; border-top: 2px solid #333; padding-top: 10px;">
                    <span class="label">TOTAL PAID</span>
                    <span class="val" id="tPrice">--</span>
                </div>
            </div>
        </div>

        <div style="margin-top: 30px; display: flex; justify-content: center; gap: 20px; align-items: center; flex-wrap: wrap;">
            
            <button onclick="downloadTicket()" class="pay-action-btn" style="width: auto; margin: 0; padding: 12px 25px; background: #333; box-shadow: none;">
                ‚¨á Download Ticket
            </button>
            
            <a href="mybookings.html" class="pay-action-btn" style="width: auto; margin: 0; padding: 12px 25px; background: #ff4d88; color: white; text-decoration: none; display: flex; align-items: center; justify-content: center;">
                Go to My Bookings
            </a>

            <a href="search.html" style="color: #666; text-decoration: underline; font-weight: 600; font-size: 14px;">
                Book Another Flight
            </a>
        </div>

    </div>

    <script>
        //const API = "http://127.0.0.1:8000";
        
        const API_BASE = "https://flight-backend-d2cb.onrender.com";
        const bookingId = localStorage.getItem("temp_booking_id");
        let details = {};

        // 1. Fetch Booking Details
        document.addEventListener("DOMContentLoaded", async () => {
            if(!bookingId) { alert("No booking found"); window.location.href="search.html"; return; }

            try {
                const res = await fetch(`${API}/booking/id/${bookingId}`);
                if(!res.ok) throw new Error("API Error");
                
                details = await res.json();
                
                // Update Summary UI
                document.getElementById("sumFlight").innerText = details.flight_number;
                const route = details.origin.split('(')[0] + " ‚ûù " + details.destination.split('(')[0];
                document.getElementById("sumRoute").innerText = route;
                document.getElementById("sumPassCount").innerText = details.passenger_count;
                document.getElementById("sumSeats").innerText = details.seats;
                document.getElementById("sumDate").innerText = details.travel_date;
                document.getElementById("sumAmount").innerText = "‚Çπ" + details.amount;
                document.getElementById("payBtn").innerText = `Pay ‚Çπ${details.amount}`;

            } catch(e) { alert("Error loading booking details"); }
        });

        // 2. Tab Switcher
        function switchMethod(m) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('form-card').classList.add('hidden');
            document.getElementById('form-upi').classList.add('hidden');
            document.getElementById('form-net').classList.add('hidden');
            
            event.target.classList.add('active');
            document.getElementById(`form-${m}`).classList.remove('hidden');
        }

        // 3. Card Formatting
        document.getElementById('cardNum').addEventListener('input', function (e) {
            e.target.value = e.target.value.replace(/[^\d]/g, '').replace(/(.{4})/g, '$1 ').trim();
        });

        // 4. Process Payment
        async function processPayment() {
            const btn = document.getElementById("payBtn");
            btn.innerText = "Processing Transaction..."; 
            btn.disabled = true;
            btn.style.opacity = "0.7";

            try {
                const res = await fetch(`${API}/booking/pay/${bookingId}`, { method: "POST" });
                const data = await res.json();

                if(data.status === "SUCCESS") {
                    // Populate Ticket
                    document.getElementById("tPnr").innerText = data.pnr;
                    document.getElementById("tDate").innerText = details.travel_date;
                    document.getElementById("tTime").innerText = details.departure_time;
                    document.getElementById("tOrigin").innerText = details.origin;
                    document.getElementById("tDest").innerText = details.destination;
                    document.getElementById("tPrice").innerText = "‚Çπ" + details.amount;

                    const names = details.passengers.split(", ");
                    const seats = details.seats.split(", ");
                    let html = "";
                    for(let i=0; i<names.length; i++) {
                        html += `<tr><td>${names[i]}</td><td style="text-align: right; color: #ff4d88;">${seats[i]}</td></tr>`;
                    }
                    document.getElementById("pListBody").innerHTML = html;

                    // Switch UI
                    document.getElementById("paymentSection").classList.add("hidden");
                    document.getElementById("successSection").classList.remove("hidden");
                    
                    // Show Ticket
                    document.getElementById("ticketContainer").style.display = "block";
                } else {
                    alert("Payment Declined. Please try again."); 
                    btn.disabled = false;
                    btn.innerText = `Pay ‚Çπ${details.amount}`;
                    btn.style.opacity = "1";
                }
            } catch(e) { 
                alert("Server Error during payment"); 
                btn.disabled = false;
                btn.innerText = `Pay ‚Çπ${details.amount}`;
                btn.style.opacity = "1";
            }
        }

        // 5. PDF Download (Existing & Working Logic)
        function downloadTicket() {
            const element = document.getElementById("ticketContainer");
            window.scrollTo(0, 0); // Ensure full visibility for capture

            const opt = {
                margin: 10,
                filename: `SkyBook_Ticket_${document.getElementById("tPnr").innerText}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save();
        }
    </script>
</body>
</html>